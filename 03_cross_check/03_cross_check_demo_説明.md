# 03_cross_check_demo.py の説明

## 概要
複数のブラウザを同時に操作して、情報を収集・クロスチェックするデモです。
オブジェクト指向設計により、ブラウザ間でのデータ共有と自動処理を実現しています。

## 現在の状態
⚠️ このスクリプトは開発中です。URL自動取得機能に課題があり、現在は手動入力のフォールバック機能を実装しています。

## 何をするスクリプト？
1. **ブラウザA**: Googleで「Amazon Nova」を検索し、上位3件のURLを取得（試行）
2. **ブラウザB**: 取得したURLのうち最初の2件を開いて内容を要約

## 主要なクラス

### 1. `SearchResult`
検索結果を保存するデータクラス
- 検索クエリ、URL、要約を管理
- URLと要約の追加メソッドを提供

### 2. `BrowserSession`
1つのブラウザを操作するクラス
- ブラウザの起動・終了（コンテキストマネージャー対応）
- Nova Actへの指示実行
- セッション内データの保存・取得

### 3. `BrowserOrchestrator`
複数のブラウザを統括管理するクラス
- 複数ブラウザセッションの作成
- ブラウザ間でのデータ共有（`shared_data`辞書）
- Workflowの一元管理

### 4. `wait_for_key()`
ユーザー承認を取得する関数
- Enterキー: 処理を続行
- Escキー: 処理を中断
- その他のキー: 無効（再入力を促す）

## 実行の流れ

```
起動
 ↓
BrowserOrchestrator起動
 ↓
【ブラウザA】
  Google検索実行
   ↓
  検索結果から1件ずつURLを取得（試行）
   ↓
  正規表現でURL抽出を試みる
   ↓
  失敗した場合は手動入力を促す
   ↓
  最低2件のURLを確保
   ↓
  共有データに保存
   ↓
  [Enter/Esc] 確認
 ↓
【ブラウザB】
  共有データからURL取得
   ↓
  1つ目のURL表示
   ↓
  [Enter/Esc] 確認
   ↓
  1つ目のURLで起動（starting_page）
   ↓
  内容を要約
   ↓
  2つ目のURL表示
   ↓
  [Enter/Esc] 確認
   ↓
  アドレスバーに2つ目のURLを入力
   ↓
  内容を要約
   ↓
  [Enter/Esc] 確認
 ↓
最終結果表示
```

## 使い方

```bash
python3 03_cross_check_demo.py
```

### 操作方法

#### フェーズ1: ブラウザAでURL収集
1. Google検索が実行される
2. Novaが各検索結果のURLを取得しようと試みる
3. URL自動取得が失敗した場合:
   - 手動でURLを入力（2件必要）
4. Enter/Escで次のフェーズへ

#### フェーズ2: ブラウザBでURL確認
1. **1つ目のURL**
   - URLが表示される
   - Enter: URLを開いて要約
   - Esc: 処理を中断

2. **2つ目のURL**
   - URLが表示される
   - Enter: アドレスバーにURLを入力して開く
   - Esc: 2つ目をスキップ

3. **最終確認**
   - Enter: 結果を表示して終了
   - Esc: すぐに終了

## 技術的なポイント

### データ共有の仕組み
```python
# ブラウザAでデータを保存
orchestrator.share_data("urls", urls)

# ブラウザBでデータを取得
urls = orchestrator.get_shared_data("urls")
```

### URL取得の課題
現在の実装では、`ActResult`オブジェクトにNovaの返答テキストが含まれていないため、URL自動取得が困難です。

**試行した方法:**
- Novaに「URLを1件ずつ取得」と指示
- `ActResult`を文字列化してURLを正規表現で抽出
- 結果: メタデータのみが取得され、実際のURLは取得できず

**現在の対策:**
- 手動入力のフォールバック機能を実装
- ユーザーが検索結果を見てURLを入力

### URL開き方の違い
- **1つ目のURL**: `BrowserSession`の`starting_page`として起動時に開く
- **2つ目のURL**: アドレスバーに入力して開く
  ```python
  browser_b.execute(
      "ブラウザのアドレスバーをクリックして、"
      "このURL『{url}』を入力してEnterキーを押してください"
  )
  ```

### エラーハンドリング
- URL取得数の検証（最低2件必要）
- 各ステップでの中断処理
- コンテキストマネージャーによる適切なリソース管理
- 手動入力フォールバック

## 既知の問題

1. **URL自動取得が機能しない**
   - `ActResult`にテキスト返答が含まれない
   - 現在は手動入力で対応

2. **改善が必要な点**
   - より確実なURL取得方法の実装
   - スクリーンショットやDOM解析の活用
   - `act_get()`メソッドの活用検討

## 推奨される代替スクリプト

より実用的なシナリオとして、`04_research_demo.py`の使用を推奨します:
- URL自動取得の問題を回避
- 検索結果のリンクを直接クリック
- 実用的な情報収集ワークフロー

## 拡張可能性
- URL取得方法の改善
- スクリーンショット解析の導入
- 他のシナリオへの応用（価格比較、フォーム入力など）
- 並行処理への拡張
